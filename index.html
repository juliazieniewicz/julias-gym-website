<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Julia's Gym Routine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { indigo: '#485696', teal: '#087e8b', ice: '#c9f6f7', green: '#d3fac7', pink: '#ffb7c3' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 30px -10px rgba(49, 59, 114, 0.05); }
        .variant-select { appearance: none; background: transparent; padding-right: 1.5rem; cursor: pointer; border-bottom: 1px dashed #313b72; font-weight: 700; outline: none; color: #313b72; }
        .pb-badge { background: #d3fac7; color: #065f46; font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 6px; text-transform: uppercase; margin-left: 8px; display: inline-flex; align-items: center; gap: 3px; }
        .history-pane { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #fdfdfd; border-radius: 12px; }
        .history-pane.open { max-height: 250px; overflow-y: auto; margin-bottom: 1rem; padding: 0.5rem; border: 1px solid #f1f5f9; }
        .toggle-btn-active { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); color: #313b72 !important; }
        
        .check-container { position: relative; width: 44px; height: 44px; cursor: pointer; }
        .check-container input { display: none; }
        .checkmark { position: absolute; top: 0; left: 0; height: 44px; width: 44px; background-color: white; border: 2px solid #e2e8f0; border-radius: 12px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .check-container input:checked ~ .checkmark { border-color: currentColor; background-color: currentColor; transform: scale(0.9); }
        .checkmark:after { content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900; color: white; display: none; font-size: 1.2rem; }
        .check-container input:checked ~ .checkmark:after { display: block; }

        body.home-mode .gym-view { display: none !important; }
        body.home-mode .home-view { display: block !important; }
        body:not(.home-mode) .home-view { display: none !important; }
        canvas { max-width: 100% !important; }
    </style>
</head>

<body class="text-indigo antialiased h-screen flex flex-col md:flex-row overflow-hidden">

    <aside class="w-64 bg-indigo text-white hidden md:flex flex-col z-20 shadow-2xl relative overflow-hidden pb-24">
        <div class="p-8 relative z-10">
            <h1 class="text-3xl font-black tracking-tighter leading-none">STRENGTH<br><span class="text-ice">.OS</span></h1>
            <p class="text-[10px] text-pink font-bold tracking-widest mt-2 uppercase text-center">v17.6 Pro</p>
        </div>
        <nav class="flex-1 px-4 space-y-3 overflow-y-auto z-10">
            <button class="nav-item w-full flex items-center gap-4 p-3 rounded-xl text-sm font-semibold text-white/70 hover:bg-white/10 hover:text-white transition-all" data-target="day1"><i class="fa-solid fa-dumbbell w-6 text-center text-rose-400"></i><span>Quads & Glutes</span></button>
            <button class="nav-item w-full flex items-center gap-4 p-3 rounded-xl text-sm font-semibold text-white/70 hover:bg-white/10 hover:text-white transition-all" data-target="day2"><i class="fa-solid fa-person-running w-6 text-center text-amber-400"></i><span>Hams & Glutes</span></button>
            <button class="nav-item w-full flex items-center gap-4 p-3 rounded-xl text-sm font-semibold text-white/70 hover:bg-white/10 hover:text-white transition-all" data-target="day3"><i class="fa-solid fa-hand-fist w-6 text-center text-sky-400"></i><span>Push</span></button>
            <button class="nav-item w-full flex items-center gap-4 p-3 rounded-xl text-sm font-semibold text-white/70 hover:bg-white/10 hover:text-white transition-all" data-target="day4"><i class="fa-solid fa-arrow-up-right-dots w-6 text-center text-violet-400"></i><span>Pull</span></button>
            <div class="my-4 border-t border-white/10 mx-4"></div>
            <button class="nav-item w-full flex items-center gap-4 p-3 rounded-xl text-sm font-semibold text-white/70 hover:bg-white/10 hover:text-pink transition-all" data-target="targets"><i class="fa-solid fa-bullseye w-6 text-center text-pink"></i><span>Goals & PBs</span></button>
            <button class="nav-item w-full flex items-center gap-4 p-3 rounded-xl text-sm font-semibold text-white/70 hover:bg-white/10 hover:text-teal transition-all" data-target="analytics"><i class="fa-solid fa-chart-line w-6 text-center text-teal"></i><span>Analytics</span></button>
        </nav>
        <div class="p-6 bg-white/5 backdrop-blur-md space-y-4">
            <div class="flex items-center justify-between">
                <span class="text-xs font-bold uppercase tracking-widest text-ice">Home Mode</span>
                <input type="checkbox" class="accent-teal w-4 h-4 cursor-pointer home-mode-toggle">
            </div>
            <button onclick="resetSession()" id="reset-btn-desk" class="w-full py-2 bg-rose-500/20 text-rose-200 rounded-lg text-[10px] font-black uppercase hover:bg-rose-500 hover:text-white transition-all">Reset Session</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative h-full bg-[#F8FAFC]">
        <header class="sticky top-0 z-30 bg-white/95 backdrop-blur-xl border-b border-ice px-6 py-4 shadow-sm">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div class="flex justify-between w-full md:w-auto items-center">
                    <div>
                        <h2 class="text-[10px] font-black text-indigo/40 uppercase tracking-[0.2em] mb-1">Performance Intelligence</h2>
                        <h3 class="text-2xl font-black text-indigo tracking-tight" id="activeTitle">Quads & Glutes</h3>
                    </div>
                    <button onclick="resetSession()" id="reset-btn-mob" class="md:hidden py-2 px-4 bg-slate-100 text-slate-400 rounded-lg text-[10px] font-black uppercase">Reset</button>
                </div>
                <div class="w-full md:w-1/3 flex flex-col gap-1">
                    <div class="flex justify-between text-[10px] font-bold text-indigo/40"><span>Completion</span><span id="progress-text">0%</span></div>
                    <div class="h-2 w-full bg-ice rounded-full overflow-hidden"><div id="progress-bar" class="h-full bg-teal w-0 transition-all duration-700"></div></div>
                </div>
            </div>
        </header>

        <div class="p-4 pb-40 md:p-10 max-w-6xl mx-auto space-y-6" id="content-area">
            <div id="day1" class="workout-view space-y-6"></div>
            <div id="day2" class="workout-view hidden space-y-6"></div>
            <div id="day3" class="workout-view hidden space-y-6"></div>
            <div id="day4" class="workout-view hidden space-y-6"></div>
            
            <section id="targets" class="workout-view hidden space-y-6">
                <div class="flex bg-slate-200 p-1 rounded-xl w-fit mx-auto">
                    <button id="btn-day" class="px-6 py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all toggle-btn-active" onclick="setGoalView('day')">By Day</button>
                    <button id="btn-muscle" class="px-6 py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all text-slate-500" onclick="setGoalView('muscle')">By Muscle</button>
                </div>
                <div id="goals-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </section>

            <section id="analytics" class="workout-view hidden space-y-8">
                <div class="glass-panel p-6 rounded-3xl border-2 border-dashed border-teal/20">
                    <h4 class="text-xs font-black uppercase mb-4 text-teal">Data Management</h4>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="exportData()" class="bg-indigo text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2 hover:scale-105 transition-transform"><i class="fa-solid fa-download"></i> Backup Data</button>
                        <label class="bg-teal text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2 hover:scale-105 transition-transform cursor-pointer"><i class="fa-solid fa-upload"></i> Restore Data <input type="file" id="importFile" class="hidden" onchange="importData(event)"></label>
                        <button onclick="clearAllData()" class="bg-rose-100 text-rose-600 px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2"><i class="fa-solid fa-trash"></i> Reset All</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="glass-panel p-6 rounded-3xl overflow-hidden">
                        <h4 class="text-xs font-black uppercase mb-4 text-indigo/40">7-Day Volume Distribution</h4>
                        <div class="relative h-64 w-full flex items-center justify-center p-2">
                            <canvas id="volumeChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-3xl">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                            <h4 class="text-xs font-black uppercase text-indigo/40">Weight Progression</h4>
                            <select id="chartExSelector" onchange="updateProgressionChart()" class="w-full sm:w-auto text-[10px] font-bold border-b border-indigo outline-none bg-transparent py-1"></select>
                        </div>
                        <div class="h-64"><canvas id="progressionChart"></canvas></div>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-3xl">
                    <h4 class="text-xs font-black uppercase mb-6 text-indigo/40">PB History by Day</h4>
                    <div id="pb-table-container" class="space-y-8"></div>
                </div>
            </section>
        </div>
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-ice z-40 grid grid-cols-6 gap-1 py-3 px-1 pb-safe shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)]">
        <button class="nav-item-mobile flex flex-col items-center justify-center gap-1" data-target="day1"><i class="fa-solid fa-dumbbell text-rose-500"></i><span class="text-[8px] font-black">Quads & Glutes</span></button>
        <button class="nav-item-mobile flex flex-col items-center justify-center gap-1" data-target="day2"><i class="fa-solid fa-person-running text-amber-500"></i><span class="text-[8px] font-black">Hams & Glutes</span></button>
        <button class="nav-item-mobile flex flex-col items-center justify-center gap-1" data-target="day3"><i class="fa-solid fa-hand-fist text-sky-500"></i><span class="text-[8px] font-black">Push</span></button>
        <button class="nav-item-mobile flex flex-col items-center justify-center gap-1" data-target="day4"><i class="fa-solid fa-arrow-up-right-dots text-violet-500"></i><span class="text-[8px] font-black">Pull</span></button>
        <button class="nav-item-mobile flex flex-col items-center justify-center gap-1" data-target="targets"><i class="fa-solid fa-bullseye text-pink"></i><span class="text-[8px] font-black text-black">Goals</span></button>
        <button class="nav-item-mobile flex flex-col items-center justify-center gap-1" data-target="analytics"><i class="fa-solid fa-chart-line text-teal"></i><span class="text-[8px] font-black text-black">Analytics</span></button>

        
    </nav>

    <div id="pb-toast" class="fixed top-24 right-4 bg-teal text-white p-4 rounded-2xl shadow-xl transform translate-x-[150%] transition-transform duration-500 z-50 flex items-center gap-4"><i class="fa-solid fa-trophy text-pink text-xl"></i><div class="text-sm font-bold" id="pb-toast-msg"></div></div>

    <script>
        let currentGoalView = 'day';
        let resetConfirm = false;
        let volumeChartInstance = null;
        let progressionChartInstance = null;

        const themes = {
            day1: { color: '#f43f5e', accent: 'text-rose-500', bg: 'bg-rose-500', light: 'bg-rose-50' },
            day2: { color: '#f59e0b', accent: 'text-amber-500', bg: 'bg-amber-500', light: 'bg-amber-50' },
            day3: { color: '#0ea5e9', accent: 'text-sky-500', bg: 'bg-sky-500', light: 'bg-sky-50' },
            day4: { color: '#8b5cf6', accent: 'text-violet-500', bg: 'bg-violet-500', light: 'bg-violet-50' },
            targets: { color: '#087e8b', accent: 'text-teal', bg: 'bg-teal' },
            analytics: { color: '#087e8b', accent: 'text-teal', bg: 'bg-teal' }
        };

        const workoutData = {
            day1: [
                { id: "d1-ex1", muscle: "Quads", num: 1, name: "Leg Press", homeName: "Weighted Step-Ups", gymLoad: "60kg", homeLoad: "8kg", reps: "3 x 10-15", gymNote: "Push through heels. Keep back flat. Control lowering. Keep early in the workout for maximum weight." },
                { id: "d1-ex2", muscle: "Quads", num: 2, name: "Smith Machine BB Squats / DB Goblet Squats", homeName: "Heels-Elevated Goblet", gymLoad: "25kg / 20kg", homeLoad: "18kg KB", reps: "3 x 8-12", gymNote: "Plate under heels, push shoulders into bar for balance. / Maintain upright chest, push knees out, deep as comfortable, squeeze glutes at the top." },
                { id: "d1-ex3", muscle: "Quads", num: 3, name: "Bulgarian Split Squat", homeName: "Bulgarian Split Squat", gymLoad: "14kg", homeLoad: "16kg", reps: "3 x 8-12", gymNote: "Driving up through the front heel. Start with lower bench and go lower into ground to feel more in glutes while hinged at the hips. Deep hip hinge for glute feel." },
                { id: "d1-ex4", muscle: "Quads", num: 4, name: "Leg Extensions", homeName: "Wall Sits", gymLoad: "35kg", homeLoad: "0", reps: "3 x 8-12", gymNote: "Squeeze quads hard at the top." },
                { id: "d1-ex5", muscle: "Glutes", num: 5, name: "DB Hip Bridge / BB Hip Thrust", homeName: "Hip Thrust", gymLoad: "24kg / 40kg", homeLoad: "20kg", reps: "3 x 10-15", gymNote: "Drive through heels, squeeze glutes hard at the top. Avoid arching lower back. Include 10-sec hold & 10 pulses on the last rep. / Drive through heels, squeeze glutes hard at the top. Avoid arching lower back. Include 10-sec hold & 10 pulses on the last rep. Shoulder blades into bench. If using Smith machine mighth have to use steps to elevate feet." },
                { id: "d1-ex6", muscle: "Glutes", num: 6, name: "Adductor Machine", homeName: "Cossack Squats", gymLoad: "40kg", homeLoad: "0", reps: "3 x 15-20", gymNote: "Complements quad work for overall leg shape." }
            ],
            day2: [
                { id: "d2-ex1", muscle: "Hamstrings", num: 1, name: "BB RDLs / Cable RDLs", homeName: "Barbell RDLs", gymLoad: "35kg / 45kg", homeLoad: "30kg", reps: "3 x 10-15", gymNote: "Focus on correct form and stretch in the hamstrings. / Lean back into cable to maintain balance. Should feel tension throughout the movement." },
                { id: "d2-ex2", muscle: "Quads", num: 2, name: "KB Sumo Squats", homeName: "Sumo Squats", gymLoad: "32kg", homeLoad: "20kg KB", reps: "3 x 10-15", gymNote: "Wide stance, toes slightly out. Lean forward to keep chest in line with back. Push knees out over toes. Squeeze glutes hard at the top. Use steps for extra stretch." },
                { id: "d2-ex3", muscle: "Glutes", num: 3, name: "45° Hip Extensions", homeName: "BB Good Mornings", gymLoad: "15kg", homeLoad: "15kg", reps: "3 x 10-12", gymNote: "Focus on glute squeeze at the top. Chin tucked & core engaged. Pad right below hip crease, drive hips into pad on the way up." },
                { id: "d2-ex4", muscle: "Hamstrings", num: 4, name: "Hamstring Curls", homeName: "Lying DB Curls", gymLoad: "35kg", homeLoad: "10kg", reps: "3 x 12-18", gymNote: "Slow and controlled contractions." },
                { id: "d2-ex5", muscle: "Glutes", num: 5, name: "Hip Abductions", homeName: "Side Lying Raises", gymLoad: "60kg", homeLoad: "5kg", reps: "3 x 15-20", gymNote: "Lean forward to further squeeze side glutes." },
                { id: "d2-ex6", muscle: "Glutes", num: 6, name: "Hamstring Slides / Cable Kickbacks", homeName: "Hamstring Slides", gymLoad: "0 / 12.5kg", homeLoad: "0", reps: "3 x 10-15", gymNote: "Focus on 3s slow lowering, progress by adding a 2-3s pause at the top, the move to single leg. / Focus on squeeze at the top. Stand on plate for greater range of motion." }
            ],
            day3: [
                { id: "d3-ex1", muscle: "Chest", num: 1, name: "Incline DB Press", homeName: "Floor DB Press", gymLoad: "18kg", homeLoad: "20kg", reps: "3 x 8-12", gymNote: "Bench at 35°-45°. If using Smith machine, position in line with shoulders." },
                { id: "d3-ex2", muscle: "Chest", num: 2, name: "DB Flyes", homeName: "DB Flyes", gymLoad: "12kg", homeLoad: "12kg", reps: "3 x 12-18", gymNote: "Focus on a good stretch and squeeze in the chest. Control the movement." },
                { id: "d3-ex3", muscle: "Chest", num: 3, name: "Push Ups", homeName: "Push Ups", gymLoad: "0", homeLoad: "0", reps: "3 x AMRAP", gymNote: "Keep body in a straight line. Drop to knees if full is capped." },
                { id: "d3-ex4", muscle: "Shoulders", num: 4, name: "DB Shoulder Press", homeName: "DB Shoulder Press", gymLoad: "14kg", homeLoad: "16kg", reps: "3 x 8-12", gymNote: "Keep core tight, back pressed back, press directly overhead, control the descent. 75°-80° angle." },
                { id: "d3-ex5", muscle: "Shoulders", num: 5, name: "Lateral Raises", homeName: "Lateral Raises", gymLoad: "5kg", homeLoad: "5kg", reps: "3 x 15-20", gymNote: " Lead with elbows, lift to shoulder height only. Control the lowering phase. Cable version as an optional swap for constant tension." },
                { id: "d3-ex6", muscle: "Triceps", num: 6, name: "Cable Tricep Pushdowns", homeName: "Tricep Kickbacks", gymLoad: "12kg", homeLoad: "5kg", reps: "3 x 10-15", gymNote: "Use rope with cable all the way up. Arms directly perpendicular to the floor, hips higned slightly back. Keep elbows by side." },
                { id: "d3-ex7", muscle: "Triceps", num: 7, name: "Cable Overhead Tricep Extensions", homeName: "DB Overhead Extensions", gymLoad: "6kg", homeLoad: "8kg", reps: "3 x 10-15", gymNote: "Pull rope above head. Fully stretched when down towards the cable. Pull up from about quad level." }
            ],
            day4: [
                { id: "d4-ex1", muscle: "Back", num: 1, name: "Lat Pull Down", homeName: "DB Pullovers", gymLoad: "35kg", homeLoad: "15kg", reps: "3 x 8-12", gymNote: "Pull bar towards upper chest, drive elbows down and back. Focus on lat squeeze." },
                { id: "d4-ex2", muscle: "Back", num: 2, name: "Assisted Pull Ups", homeName: "Inverted Rows", gymLoad: "-21kg", homeLoad: "0", reps: "3 x 6-8", gymNote: "Imagine ripping the bar in two. Do more reps over less weight." },
                { id: "d4-ex3", muscle: "Back", num: 3, name: "Chest Supported Incline DB Row", homeName: "Single-Arm DB Row", gymLoad: "20kg", homeLoad: "12kg", reps: "3 x 10-15", gymNote: "Bench at 35°-45°. Lean back on legs and push chest against bench. Push elbows towards ceiling." },
                { id: "d4-ex4", muscle: "Back", num: 4, name: "Single Arm Dumbbell Row / T-Bar Row", homeName: "Bent Over Row", gymLoad: "14kg / 14kg", homeLoad: "14kg", reps: "3 x 8-10", gymNote: "Maintain flat back. Pull towards hip. Squeeze shoulder blades. Tuck thumb under. / TBC" },
                { id: "d4-ex5", muscle: "Back", num: 5, name: "Cable Face Pulls", homeName: "Band Pull Aparts", gymLoad: "17.5kg", homeLoad: "0", reps: "3 x 15-20", gymNote: "High reps. Focus on seperating rope ends. Tuck rope under thumbs with thumb facing upwards. Pull towards forehead. Aim to almost tear the rope in half." },
                { id: "d4-ex6", muscle: "Biceps", num: 6, name: "Alt. Bicep Curls", homeName: "Alt Bicep Curls", gymLoad: "7kg", homeLoad: "7kg", reps: "3 x 8-10", gymNote: "Focus on strict form, keep elbows glued to side. Remember the pinky trick for extra stretch." },
                { id: "d4-ex7", muscle: "Biceps", num: 7, name: "Hammer Curls", homeName: "Hammer Curls", gymLoad: "8kg", homeLoad: "7kg", reps: "3 x 8-10", gymNote: "Palms facing one another, control the movement." }
            ]
        };

        function formatW(val) { const num = parseFloat(val); if (num === 0) return "BW"; return num + "kg"; }
function getVariants(ex) {
    const names = ex.name.split(/\s*\/\s*/);
    let loads = ex.gymLoad.split(/\s*\/\s*/);
    
    return names.map((n, i) => {
        const raw = (loads[i] || loads[0]).trim();
        const baseline = parseFloat(raw.match(/(-?\d+(?:\.\d+)?)/)?.[0] || 0);
        
        // Robust check: checks both the full name and the variant name
        const isAssisted = n.toLowerCase().includes("assisted") || 
                          ex.name.toLowerCase().includes("assisted");
        
        return { 
            id: ex.id, 
            index: i, 
            name: n.trim(), 
            muscle: ex.muscle, 
            num: ex.num, 
            isAssisted, 
            baseline, 
            target: isAssisted ? 0 : Math.ceil(baseline * 1.30) 
        };
    });
}
        function getHistory(id, idx) { const h = localStorage.getItem(`sb_hist_${id}_${idx}`); return h ? JSON.parse(h) : []; }
        function getPB(id, idx) { return parseFloat(localStorage.getItem(`sb_pb_${id}_${idx}`)) || 0; }

function saveLog(id) {
    const input = document.getElementById(`input-${id}`);
    const idx = document.getElementById(`select-${id}`)?.value || 0;
    const noteText = input.value.trim();

    if (noteText) {
        const ex = Object.values(workoutData).flat().find(e => e.id === id);
        const v = getVariants(ex)[idx];

        // 1. Extract ALL numbers from the note
        const weightMatches = noteText.match(/-?\d+(\.\d+)?/g);
        let extractedWeight = null;

        if (weightMatches) {
            const numbers = weightMatches.map(Number);
            
            if (v.isAssisted) {
                // For assisted: Pick the number CLOSEST to zero (least help)
                // This correctly picks -18 over -25
                extractedWeight = numbers.reduce((prev, curr) => 
                    Math.abs(curr) < Math.abs(prev) ? curr : prev
                );
            } else {
                // For standard: Pick the HIGHEST number
                extractedWeight = Math.max(...numbers);
            }
        }

        const date = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        const currentHist = getHistory(id, idx);
        
        currentHist.push({ date, note: noteText, detectedWeight: extractedWeight });
        localStorage.setItem(`sb_hist_${id}_${idx}`, JSON.stringify(currentHist));

        if (extractedWeight !== null) {
            const currentPB = getPB(id, idx);
            
            let isBetter = false;
            if (v.isAssisted) {
                // Better PB = lower absolute weight (e.g., 18kg help is better than 25kg help)
                isBetter = (Math.abs(extractedWeight) < Math.abs(currentPB) || currentPB === 0);
            } else {
                // Better PB = higher weight
                isBetter = (extractedWeight > currentPB);
            }

            if (isBetter) localStorage.setItem(`sb_pb_${id}_${idx}`, extractedWeight);
        }

        updateDisplayLoad(id, idx);
        input.value = ''; 
        input.placeholder = "Saved!";
        setTimeout(() => input.placeholder = "Log weight...", 2000);
    }
}

        function deleteLog(id, entryIndex) {
    const idx = document.getElementById(`select-${id}`)?.value || 0;
    let hist = getHistory(id, idx);
    hist.splice(entryIndex, 1);
    localStorage.setItem(`sb_hist_${id}_${idx}`, JSON.stringify(hist));
    
    const weights = hist.filter(h => h.detectedWeight !== null).map(h => h.detectedWeight);
    const ex = Object.values(workoutData).flat().find(e => e.id === id);
    const v = getVariants(ex)[idx];
    
    let newPB = 0;
    if (weights.length > 0) {
        if (v.isAssisted) {
            // Recalculate PB by finding the number closest to zero
            newPB = weights.reduce((prev, curr) => Math.abs(curr) < Math.abs(prev) ? curr : prev);
        } else {
            newPB = Math.max(...weights);
        }
    }
    
    localStorage.setItem(`sb_pb_${id}_${idx}`, newPB);
    updateDisplayLoad(id, idx);
    renderHistoryLog(id);
}

function updateDisplayLoad(exId, val) {
    const ex = Object.values(workoutData).flat().find(e => e.id === exId);
    const variant = getVariants(ex)[val];
    document.getElementById(`disp-${exId}`).textContent = formatW(variant.baseline);

    // Logic to update the instruction box based on variation selection
    const notes = ex.gymNote.split(/\s*\/\s*/);
    const activeNote = (notes[val] || notes[0]).trim();
    const noteSpan = document.getElementById(`note-text-${exId}`);
    if (noteSpan) noteSpan.textContent = activeNote;

    const pb = getPB(exId, val);
    const badge = document.getElementById(`pb-badge-${exId}`);
    document.getElementById(`pb-val-${exId}`).textContent = formatW(pb);
    badge.classList.toggle('hidden', pb === 0);
    if(document.getElementById(`hist-pane-${exId}`).classList.contains('open')) renderHistoryLog(exId);
}

        function toggleHistory(id) {
            const pane = document.getElementById(`hist-pane-${id}`);
            pane.classList.toggle('open');
            renderHistoryLog(id);
        }

        function renderHistoryLog(id) {
            const idx = document.getElementById(`select-${id}`)?.value || 0;
            const pane = document.getElementById(`hist-list-${id}`);
            const hist = getHistory(id, idx);
            if (hist.length === 0) { pane.innerHTML = `<div class="text-[10px] py-2 text-slate-400 italic">No historical logs.</div>`; return; }
            pane.innerHTML = hist.slice().reverse().map((entry, reverseIdx) => {
                const actualIdx = hist.length - 1 - reverseIdx;
                return `<div class="py-2 border-b border-slate-100 flex items-start justify-between group">
                    <div class="flex flex-col gap-0.5">
                        <div class="flex gap-2 items-center"><span class="text-[8px] font-black uppercase text-slate-400">${entry.date}</span>${entry.detectedWeight !== null ? `<span class="text-[8px] font-bold text-teal bg-teal/5 px-1 rounded">${formatW(entry.detectedWeight)}</span>` : ''}</div>
                        <div class="text-[11px] text-indigo/80 leading-snug">${entry.note}</div>
                    </div>
                    <button onclick="deleteLog('${id}', ${actualIdx})" class="text-slate-300 hover:text-rose-500 p-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-trash-can text-[10px]"></i></button>
                </div>`;
            }).join('');
        }

        function renderWorkouts() {
    Object.keys(workoutData).forEach(dayKey => {
        const container = document.getElementById(dayKey); container.innerHTML = '';
        const theme = themes[dayKey];
        workoutData[dayKey].forEach((ex) => {
            const variants = getVariants(ex);
            const pb = getPB(ex.id, 0);
            const isChecked = localStorage.getItem(`done_${ex.id}`) === 'true';
            
            // Logic to grab only the first part of the instruction initially
            const notes = ex.gymNote.split(/\s*\/\s*/);
            const initialNote = notes[0].trim();

            container.innerHTML += `
                <div class="exercise-card bg-white rounded-2xl p-5 border border-ice relative hover:border-indigo transition-all ${isChecked ? 'opacity-30' : ''}" style="border-left: 4px solid ${theme.color}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1" style="color: ${theme.color}">
                            <div class="gym-view font-bold text-lg flex items-center flex-wrap">
                                <span class="mr-2 opacity-30 font-black">${ex.num}.</span>
                                ${variants.length > 1 ? `<select id="select-${ex.id}" onchange="updateDisplayLoad('${ex.id}', this.value)" class="variant-select">
                                    ${variants.map(v=>`<option value="${v.index}">${v.name}</option>`).join('')}
                                </select>` : `<span class="text-indigo">${ex.name}</span>`}
                                <span id="pb-badge-${ex.id}" class="pb-badge ${pb !== 0 ? '' : 'hidden'}"><i class="fa-solid fa-trophy"></i> <span id="pb-val-${ex.id}">${formatW(pb)}</span></span>
                            </div>
                            <div class="home-view hidden font-bold text-indigo text-lg"><span class="mr-2 opacity-30 font-black">${ex.num}.</span>${ex.homeName}</div>
                            <div class="text-[10px] font-mono opacity-60 mt-1 uppercase tracking-widest font-bold">${ex.reps}</div>
                        </div>
                        <div class="text-right">
                            <div class="gym-view text-2xl font-black font-mono" style="color: ${theme.color}" id="disp-${ex.id}">${formatW(variants[0].baseline)}</div>
                            <div class="home-view hidden text-2xl font-black font-mono" style="color: ${theme.color}">${formatW(ex.homeLoad)}</div>
                        </div>
                    </div>
                    <div class="${theme.light} p-3 rounded-xl text-[11px] text-slate-500 mb-4 leading-relaxed flex items-start gap-2 italic">
                        <i class="fa-solid fa-lightbulb mt-0.5 opacity-50" style="color: ${theme.color}"></i>
                        <span id="note-text-${ex.id}">${initialNote}</span>
                    </div>
                    <div class="flex gap-3 items-center">
                        <input type="text" id="input-${ex.id}" class="flex-1 bg-white border border-ice rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo transition-colors" placeholder="Log weight or notes...">
                        <button onclick="saveLog('${ex.id}')" class="${theme.bg} text-white w-12 h-11 rounded-xl shadow-lg active:scale-95 transition-transform"><i class="fa-solid fa-save"></i></button>
                        <button onclick="toggleHistory('${ex.id}')" class="w-11 h-11 rounded-xl bg-slate-100 text-slate-400 flex items-center justify-center hover:bg-slate-200 transition-colors"><i class="fa-solid fa-clock-rotate-left text-xs"></i></button>
                        <label class="check-container" style="color: ${theme.color}">
                            <input type="checkbox" class="completion-check" onchange="updateCardVisuals('${ex.id}', this)" ${isChecked ? 'checked' : ''}>
                            <span class="checkmark"></span>
                        </label>
                    </div>
                    <div id="hist-pane-${ex.id}" class="history-pane"><div class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 px-1">History</div><div id="hist-list-${ex.id}" class="space-y-1 px-1"></div></div>
                </div>`;
        });
    });
}

        function updateCardVisuals(id, cb) {
            localStorage.setItem(`done_${id}`, cb.checked);
            cb.closest('.exercise-card').classList.toggle('opacity-30', cb.checked);
            calculateProgress();
        }

        function resetSession() {
            if(confirm("Reset all checks for this day?")) {
                const activeId = document.querySelector('.workout-view:not(.hidden)').id;
                document.querySelectorAll(`#${activeId} .completion-check`).forEach(c => {
                    c.checked = false;
                    const card = c.closest('.exercise-card');
                    card.classList.remove('opacity-30');
                    const exId = card.querySelector('input[type="text"]').id.replace('input-', '');
                    localStorage.removeItem(`done_${exId}`);
                });
                calculateProgress();
            }
        }

        function calculateProgress() {
            const activeId = document.querySelector('.workout-view:not(.hidden)').id;
            if(activeId === 'targets' || activeId === 'analytics') return;
            const theme = themes[activeId];
            const checks = document.querySelectorAll(`#${activeId} .completion-check`);
            const checked = document.querySelectorAll(`#${activeId} .completion-check:checked`);
            const percent = checks.length ? Math.round((checked.length / checks.length) * 100) : 0;
            const bar = document.getElementById('progress-bar');
            bar.style.width = percent + '%';
            bar.style.backgroundColor = theme.color;
            document.getElementById('progress-text').textContent = percent + '%';
            document.getElementById('reset-btn-mob').style.color = theme.color;
            document.getElementById('reset-btn-desk').style.color = theme.color;
        }

        function setGoalView(view) {
            currentGoalView = view;
            document.getElementById('btn-day').className = view === 'day' ? "px-6 py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all toggle-btn-active" : "px-6 py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all text-slate-500";
            document.getElementById('btn-muscle').className = view === 'muscle' ? "px-6 py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all toggle-btn-active" : "px-6 py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all text-slate-500";
            renderGoals();
        }

        function generateGoalItem(v) {
            const pb = getPB(v.id, v.index);
            const progress = v.target > 0 ? Math.min(Math.round((pb / v.target) * 100), 100) : 0;
            return `
                <div class="space-y-2">
                    <div class="flex justify-between items-end">
                        <div class="text-[11px] font-bold text-indigo">${v.name}</div>
                        <div class="text-[10px] font-mono text-indigo/40">${pb} / ${v.target}kg</div>
                    </div>
                    <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full bg-teal transition-all duration-1000" style="width: ${progress}%"></div>
                    </div>
                </div>`;
        }

        function renderGoals() {
            const container = document.getElementById('goals-container');
            container.innerHTML = '';
            const dataFlat = Object.keys(workoutData).flatMap(day => workoutData[day].map(ex => ({...ex, day})));
            if (currentGoalView === 'day') {
                ['day1','day2','day3','day4'].forEach(dayKey => {
                    let html = `<div class="glass-panel p-6 rounded-3xl"><h3 class="font-black uppercase text-xs mb-6" style="color: ${themes[dayKey].color}">Day ${dayKey.slice(-1)}</h3><div class="space-y-6">`;
                    dataFlat.filter(x => x.day === dayKey).forEach(ex => getVariants(ex).forEach(v => html += generateGoalItem(v)));
                    container.innerHTML += html + `</div></div>`;
                });
            } else {
                const muscles = [...new Set(dataFlat.map(x => x.muscle))];
                muscles.forEach(m => {
                    let html = `<div class="glass-panel p-6 rounded-3xl"><h3 class="font-black uppercase text-xs mb-6 text-indigo">${m}</h3><div class="space-y-6">`;
                    dataFlat.filter(x => x.muscle === m).forEach(ex => getVariants(ex).forEach(v => html += generateGoalItem(v)));
                    container.innerHTML += html + `</div></div>`;
                });
            }
        }

        // --- NEW ANALYTICS LOGIC ---
        function populateChartSelector() {
            const selector = document.getElementById('chartExSelector');
            selector.innerHTML = '';
            Object.keys(workoutData).forEach(dayKey => {
                const group = document.createElement('optgroup');
                group.label = `DAY ${dayKey.slice(-1)} - ${dayKey === 'day1' ? 'Quads' : dayKey === 'day2' ? 'Hams' : dayKey === 'day3' ? 'Push' : 'Pull'}`;
                workoutData[dayKey].forEach(ex => {
                    getVariants(ex).forEach(v => {
                        const option = document.createElement('option');
                        option.value = `${ex.id}_${v.index}`;
                        option.textContent = v.name;
                        group.appendChild(option);
                    });
                });
                selector.appendChild(group);
            });
        }

        function updateVolumeChart() {
            const ctx = document.getElementById('volumeChart').getContext('2d');
            const muscles = ["Quads", "Glutes", "Hamstrings", "Chest", "Shoulders", "Back", "Biceps", "Triceps"];
            const counts = muscles.map(m => {
                let sessionCount = 0;
                Object.values(workoutData).flat().filter(ex => ex.muscle === m).forEach(ex => {
                    getVariants(ex).forEach(v => {
                        const hist = getHistory(ex.id, v.index);
                        const lastWeek = new Date(); lastWeek.setDate(lastWeek.getDate() - 7);
                        sessionCount += hist.filter(h => new Date(h.date) > lastWeek).length;
                    });
                });
                return sessionCount;
            });

            if (volumeChartInstance) volumeChartInstance.destroy();
            volumeChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: muscles,
                    datasets: [{
                        data: counts,
                        backgroundColor: 'rgba(8, 126, 139, 0.1)',
                        borderColor: '#087e8b',
                        borderWidth: 2,
                        pointBackgroundColor: '#313b72',
                        pointRadius: 3
                    }]
                },
                options: { 
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: { 
                        r: { 
                            beginAtZero: true, 
                            ticks: { display: false, stepSize: 1 },
                            grid: { color: '#e2e8f0' },
                            pointLabels: { font: { size: 9, weight: 'bold', family: 'Inter' } }
                        } 
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

function updateProgressionChart() {
    const val = document.getElementById('chartExSelector').value;
    const [id, idx] = val.split('_');
    const ex = Object.values(workoutData).flat().find(e => e.id === id);
    const v = getVariants(ex)[idx];
    const hist = getHistory(id, parseInt(idx));
    const ctx = document.getElementById('progressionChart').getContext('2d');
    
    if (progressionChartInstance) progressionChartInstance.destroy();
    
    // Get the absolute baseline (e.g., 60 for Leg Press or 21 for Assisted Pullups)
    const baselineValue = Math.abs(v.baseline);
    
    // Map history to absolute values (e.g., -18 becomes 18)
    const chartData = hist.map(h => Math.abs(h.detectedWeight));

    progressionChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: hist.map(h => h.date),
            datasets: [{
                label: v.isAssisted ? 'Assistance (kg)' : 'Weight (kg)',
                data: chartData,
                borderColor: '#087e8b',
                backgroundColor: 'rgba(8, 126, 139, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointBackgroundColor: '#087e8b'
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.parsed.y} kg`
                    }
                }
            },
            scales: {
                y: { 
                    // 1. Don't force 0
                    beginAtZero: false, 
                    // 2. Set the "Floor" of the chart to your starting baseline
                    suggestedMin: baselineValue,
                    // 3. For Assisted, reverse so progress (lower numbers) goes UP
                    reverse: v.isAssisted,
                    grid: { color: '#f1f5f9' },
                    ticks: { font: { size: 10 } }
                },
                x: { 
                    grid: { display: false },
                    ticks: { font: { size: 10 } }
                }
            }
        }
    });
}

        function renderPBTable() {
            const container = document.getElementById('pb-table-container');
            container.innerHTML = '';
            
            Object.keys(workoutData).forEach(dayKey => {
                let dayHtml = `
                    <div class="overflow-x-auto">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1 h-4 rounded-full ${themes[dayKey].bg}"></div>
                            <h5 class="text-[10px] font-black uppercase tracking-widest text-indigo/60">Day ${dayKey.slice(-1)} PBs</h5>
                        </div>
                        <table class="w-full text-left text-[11px] mb-4">
                            <thead class="bg-slate-50 text-indigo/40">
                                <tr>
                                    <th class="p-3 rounded-l-xl">Exercise</th>
                                    <th class="p-3">Baseline</th>
                                    <th class="p-3">Personal Best</th>
                                    <th class="p-3 rounded-r-xl">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">`;
                
                workoutData[dayKey].forEach(ex => {
                    getVariants(ex).forEach(v => {
                        const pb = getPB(ex.id, v.index);
                        const isImproved = pb > v.baseline;
                        dayHtml += `
                            <tr>
                                <td class="p-3 font-semibold text-indigo">${v.name}</td>
                                <td class="p-3 text-slate-400 font-mono">${v.baseline}kg</td>
                                <td class="p-3 font-black font-mono text-indigo">${pb > 0 ? pb + 'kg' : '-'}</td>
                                <td class="p-3">
                                    <span class="uppercase text-[8px] font-bold px-2 py-1 rounded-md ${isImproved ? 'bg-green text-green-800' : 'bg-slate-100 text-slate-400'}">
                                        ${isImproved ? 'Progressing' : 'Baseline'}
                                    </span>
                                </td>
                            </tr>`;
                    });
                });
                
                dayHtml += `</tbody></table></div>`;
                container.innerHTML += dayHtml;
            });
        }

        // --- CORE NAVIGATION ---
        document.querySelectorAll('.nav-item, .nav-item-mobile').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                document.querySelectorAll('.workout-view').forEach(v => v.classList.add('hidden'));
                document.getElementById(target).classList.remove('hidden');
                document.getElementById('activeTitle').textContent = btn.innerText || target;
                
                if(target === 'targets') renderGoals();
                if(target === 'analytics') {
                    populateChartSelector();
                    updateVolumeChart();
                    updateProgressionChart();
                    renderPBTable();
                }
                calculateProgress();
            });
        });

        document.querySelector('.home-mode-toggle').addEventListener('change', (e) => {
            document.body.classList.toggle('home-mode', e.target.checked);
        });

        // Initialize
        renderWorkouts();
        calculateProgress();

        // Export/Import
        function exportData() {
            const data = {};
            for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('sb_')) data[key] = localStorage.getItem(key);
            }
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `strength_os_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                location.reload();
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if(confirm("WIPE ALL PROGRESS FOREVER?")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
